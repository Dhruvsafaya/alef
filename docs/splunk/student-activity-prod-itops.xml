<form theme="dark">
    <label>Student Activity in Alef Platform - ITops</label>
    <fieldset submitButton="false">
        <input type="dropdown" token="tenant_id" searchWhenChanged="true">
            <label>Organization</label>
            <choice value="*">Select</choice>
            <fieldForLabel>tenant_name</fieldForLabel>
            <fieldForValue>tenant_id</fieldForValue>
            <change>
                <set token="form.school_id">*</set>
            </change>
            <search>
                <query>|inputlookup prod_students.csv | table tenant_id, tenant_name | dedup tenant_id, tenant_name</query>
                <earliest>0</earliest>
                <latest></latest>
            </search>
            <default>93e4949d-7eff-4707-9201-dac917a5e013</default>
            <initialValue>*</initialValue>
        </input>
        <input type="multiselect" token="school_id" searchWhenChanged="true">
            <label>School</label>
            <choice value="*">All Schools</choice>
            <default>*</default>
            <initialValue>*</initialValue>
            <fieldForLabel>school_name</fieldForLabel>
            <fieldForValue>school_id</fieldForValue>
            <change>
                <unset token="show_details"></unset>
            </change>
            <search>
                <query>|inputlookup prod_students.csv where tenant_id="$tenant_id$"| table school_name, school_id | dedup school_id, school_name | sort school_name</query>
                <earliest>0</earliest>
                <latest></latest>
            </search>
            <delimiter> </delimiter>
        </input>
        <input type="time" searchWhenChanged="true" token="time_picker">
            <label>Time Range</label>
            <default>
                <earliestTime>@d</earliestTime>
                <latestTime>now</latestTime>
            </default>
        </input>
    </fieldset>
    <row>
        <panel>
            <title>Student Activity</title>
            <single>
                <title>Number of Active Students</title>
                <search>
                    <query>index="xapi" tenant_id="$tenant_id$" school_id IN ($school_id$) | table student_id | stats dc(student_id)</query>
                    <earliest>$time_picker.earliest$</earliest>
                    <latest>$time_picker.latest$</latest>
                    <sampleRatio>1</sampleRatio>
                    <refresh>5s</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="colorBy">value</option>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="height">102</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0x53a051","0x53a051"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="showSparkline">1</option>
                <option name="showTrendIndicator">1</option>
                <option name="trellis.enabled">0</option>
                <option name="trellis.scales.shared">1</option>
                <option name="trellis.size">medium</option>
                <option name="trendColorInterpretation">standard</option>
                <option name="trendDisplayMode">absolute</option>
                <option name="unitPosition">before</option>
                <option name="useColors">1</option>
                <option name="useThousandSeparators">1</option>
            </single>
            <single>
                <title>Number of Inactive Students</title>
                <search>
                    <query>| inputlookup prod_students.csv where tenant_id="$tenant_id$" school_id IN ($school_id$) | table student_id| stats dc(student_id) as total | appendcols [ search index="xapi" tenant_id="$tenant_id$" school_id IN ($school_id$) earliest="$time_picker.earliest$" latest="$time_picker.latest$" | table student_id| stats dc(student_id) as active] | eval inactive=(total - active) | table inactive</query>
                    <earliest>0</earliest>
                    <latest></latest>
                    <refresh>5s</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="colorBy">value</option>
                <option name="colorMode">block</option>
                <option name="drilldown">none</option>
                <option name="height">102</option>
                <option name="numberPrecision">0</option>
                <option name="rangeColors">["0xdc4e41","0xdc4e41"]</option>
                <option name="rangeValues">[0]</option>
                <option name="refresh.display">progressbar</option>
                <option name="showSparkline">1</option>
                <option name="showTrendIndicator">1</option>
                <option name="trellis.enabled">0</option>
                <option name="trellis.scales.shared">1</option>
                <option name="trellis.size">medium</option>
                <option name="trendColorInterpretation">standard</option>
                <option name="trendDisplayMode">absolute</option>
                <option name="unitPosition">after</option>
                <option name="useColors">1</option>
                <option name="useThousandSeparators">1</option>
            </single>
            <chart>
                <title>Percentage of Students Active</title>
                <search>
                    <query>| inputlookup prod_students.csv where school_id IN ($school_id$) | table student_id| stats dc(student_id) as total | appendcols [ search index="xapi" school_id IN ($school_id$) earliest="$time_picker.earliest$" latest="$time_picker.latest$" | table student_id| stats dc(student_id) as active] | eval ratio=round((active/total)*100) | table ratio</query>
                    <earliest>0</earliest>
                    <latest></latest>
                    <refresh>5s</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="charting.chart">radialGauge</option>
                <option name="charting.chart.rangeValues">[0,30,70,100]</option>
                <option name="charting.chart.style">shiny</option>
                <option name="charting.gaugeColors">["0xdc4e41","0xf1813f","0x53a051"]</option>
                <option name="refresh.display">progressbar</option>
            </chart>
        </panel>
        <panel>
            <title>Top 10 Lessons Completed by Students</title>
            <table>
                <search>
                    <query>index="learning_session" tenant_id="$tenant_id$" school_id IN ($school_id$) | rename lesson_title as "Lesson Title", subject_name as "Subject" | table * | stats avg(raw_score) as AverageScore, count as "Number of Students" by Subject, "Lesson Title" | eval AverageScore=round(AverageScore,2) | rename AverageScore as "Average Score"| sort - count</query>
                    <earliest>$time_picker.earliest$</earliest>
                    <latest>$time_picker.latest$</latest>
                    <refresh>5s</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="count">10</option>
                <option name="drilldown">none</option>
                <option name="refresh.display">progressbar</option>
                <option name="rowNumbers">false</option>
                <option name="wrap">true</option>
            </table>
        </panel>
    </row>
    <row>
        <panel>
            <title>Number of Active Students per School</title>
            <chart>
                <search>
                    <query>|inputlookup prod_students.csv where tenant_id="$tenant_id$" school_id IN ($school_id$) | table school_name,school_id | dedup school_name,school_id| join type=left school_id [search index="xapi" tenant_id="$tenant_id$"  school_id IN ($school_id$) earliest="$time_picker.earliest$" latest="$time_picker.latest$" | table student_id,school_name,school_id | rename school_name as school_name_xapi | stats dc(student_id) as active by school_name_xapi,school_id] |fillnull active value=0 |  table school_name, active,school_id | sort school_name</query>
                    <earliest>0</earliest>
                    <latest></latest>
                    <refresh>5s</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
                <option name="charting.axisLabelsX.majorLabelStyle.rotation">-90</option>
                <option name="charting.axisTitleX.visibility">collapsed</option>
                <option name="charting.axisTitleY.text">Active Percentage</option>
                <option name="charting.axisTitleY.visibility">collapsed</option>
                <option name="charting.axisTitleY2.visibility">visible</option>
                <option name="charting.axisY.abbreviation">none</option>
                <option name="charting.axisY.minimumNumber">0</option>
                <option name="charting.axisY.scale">linear</option>
                <option name="charting.chart">column</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.chart.stackMode">default</option>
                <option name="charting.drilldown">all</option>
                <option name="charting.layout.splitSeries">0</option>
                <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
                <option name="charting.legend.placement">none</option>
                <option name="charting.seriesColors">[0x34C8E8]</option>
                <option name="height">283</option>
                <option name="refresh.display">progressbar</option>
                <option name="trellis.enabled">0</option>
                <drilldown>
                    <set token="show_details"></set>
                    <set token="form.school_id">$row.school_id$</set>
                </drilldown>
            </chart>
        </panel>
    </row>
    <row>
        <panel>
            <title>Percentage of Active Students per School</title>
            <chart>
                <search>
                    <query>|inputlookup prod_students.csv where tenant_id="$tenant_id$" school_id IN ($school_id$) | table student_id, school_name,school_id| stats dc(student_id) as total by school_name,school_id| join type=left school_id [search index="xapi" tenant_id="$tenant_id$"  school_id IN ($school_id$) earliest="$time_picker.earliest$" latest="$time_picker.latest$"| table student_id,school_name,school_id| stats dc(student_id) as active by school_name,school_id] |fillnull active value=0 | eval ratio=ceil((active/total)*100) | table school_name, ratio,school_id | sort school_name</query>
                    <earliest>0</earliest>
                    <latest></latest>
                    <refresh>30s</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="charting.axisLabelsX.majorLabelStyle.overflowMode">ellipsisNone</option>
                <option name="charting.axisLabelsX.majorLabelStyle.rotation">-90</option>
                <option name="charting.axisTitleX.visibility">collapsed</option>
                <option name="charting.axisTitleY.visibility">visible</option>
                <option name="charting.axisTitleY2.visibility">visible</option>
                <option name="charting.axisY.abbreviation">none</option>
                <option name="charting.axisY.maximumNumber">100</option>
                <option name="charting.axisY.minimumNumber">0</option>
                <option name="charting.axisY.scale">linear</option>
                <option name="charting.chart">column</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.chart.stackMode">default</option>
                <option name="charting.drilldown">all</option>
                <option name="charting.layout.splitSeries">0</option>
                <option name="charting.legend.labelStyle.overflowMode">ellipsisMiddle</option>
                <option name="charting.legend.placement">none</option>
                <option name="charting.seriesColors">[0xFF9225]</option>
                <option name="refresh.display">progressbar</option>
                <option name="trellis.enabled">0</option>
                <drilldown>
                    <set token="show_details"></set>
                    <set token="form.school_id">$row.school_id$</set>
                </drilldown>
            </chart>
        </panel>
    </row>
    <row>
        <panel depends="$show_details$">
            <title>Active Percentage per Grade and Class</title>
            <chart>
                <search>
                    <query>| inputlookup prod_students.csv where tenant_id="$tenant_id$" school_id="$form.school_id$" | table class_name| dedup class_name | join type=left class_name [search index="xapi"   earliest="$time_picker.earliest$" latest="$time_picker.latest$" tenant_id="$tenant_id$" school_id="$form.school_id$" | table student_id,class_name| stats dc(student_id) as active by class_name] |fillnull active value=0 | table class_name active | sort class_name</query>
                    <earliest>0</earliest>
                    <latest></latest>
                    <refresh>10m</refresh>
                    <refreshType>delay</refreshType>
                </search>
                <option name="charting.axisY.maximumNumber">100</option>
                <option name="charting.axisY.minimumNumber">0</option>
                <option name="charting.seriesColors">[0x6338B0]</option>
                <option name="charting.chart">column</option>
                <option name="charting.chart.showDataLabels">none</option>
                <option name="charting.drilldown">none</option>
                <option name="charting.legend.placement">right</option>
                <option name="refresh.display">progressbar</option>
            </chart>
        </panel>
    </row>
</form>