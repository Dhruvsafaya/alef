# Old events
parquet-course-ability-test-planned-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-ccl-published-activity-planned-in-ability-test-component-in-course"}
parquet-course-ability-test-updated-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-ccl-published-activity-updated-in-ability-test-component-in-course"}
parquet-course-ability-test-unplanned-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-ccl-published-activity-unplanned-in-ability-test-component-in-course"}

parquet-course-ability-test-planned-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-ccl-published-activity-planned-in-ability-test-component-in-course"}
parquet-course-ability-test-updated-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-ccl-published-activity-updated-in-ability-test-component-in-course"}
parquet-course-ability-test-unplanned-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-ccl-published-activity-unplanned-in-ability-test-component-in-course"}

ability-test-planned-parquet {
  source: ["parquet-course-ability-test-planned-source"]
  sink: ["parquet-course-ability-test-planned-sink"]
}
ability-test-updated-parquet {
  source: ["parquet-course-ability-test-updated-source"]
  sink: ["parquet-course-ability-test-updated-sink"]
}
ability-test-unplanned-parquet {
  source: ["parquet-course-ability-test-unplanned-source"]
  sink: ["parquet-course-ability-test-unplanned-sink"]
}

# New events
parquet-test-planned-in-ability-test-component-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-ccl-published-test-planned-in-ability-test-component-in-course"}
parquet-test-updated-in-ability-test-component-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-ccl-published-test-updated-in-ability-test-component-in-course"}
parquet-test-unplanned-in-ability-test-component-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-ccl-published-test-unplanned-in-ability-test-component-in-course"}

parquet-test-planned-in-ability-test-component-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-ccl-published-test-planned-in-ability-test-component-in-course"}
parquet-test-updated-in-ability-test-component-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-ccl-published-test-updated-in-ability-test-component-in-course"}
parquet-test-unplanned-in-ability-test-component-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-ccl-published-test-unplanned-in-ability-test-component-in-course"}

test-planned-in-ability-test-component-parquet {
  source: ["parquet-test-planned-in-ability-test-component-source"]
  sink: ["parquet-test-planned-in-ability-test-component-sink"]
}
test-updated-in-ability-test-component-parquet {
  source: ["parquet-test-updated-in-ability-test-component-source"]
  sink: ["parquet-test-updated-in-ability-test-component-sink"]
}
test-unplanned-in-ability-test-component-parquet {
  source: ["parquet-test-unplanned-in-ability-test-component-source"]
  sink: ["parquet-test-unplanned-in-ability-test-component-sink"]
}

# Combined
parquet-course-ability-test-transformed-sink = ${parquet-source-overwrite} {"path": ${s3.path}"/"${env}"/transformed/alef-ccl-published-ability-test-component-in-course"}

redshift-course-ability-test-sink = ${redshift} {"dbtable": ${redshift-schema}".dim_course_ability_test_association"}
delta-course-ability-test-sink = ${delta-sink} {"path" = ${s3.delta.path}"/"${env}"/alef-ccl-course-ability-test-association"}

course-ability-test-transform {
  planned-source: ["parquet-course-ability-test-planned-source"]
  updated-source: ["parquet-course-ability-test-updated-source"]
  unplanned-source: ["parquet-course-ability-test-unplanned-source"]

  test-planned-source: ["parquet-test-planned-in-ability-test-component-source"]
  test-updated-source: ["parquet-test-updated-in-ability-test-component-source"]
  test-unplanned-source: ["parquet-test-unplanned-in-ability-test-component-source"]

  sink: ["parquet-course-ability-test-transformed-sink"]

  key: "dim_course_ability_test_association"
  planned-event-names: [
    "ActivityPlannedInAbilityTestComponentEvent",
    "AbilityTestComponentUpdatedEvent",
    "TestPlannedInAbilityTestComponentEvent",
    "TestUpdatedInAbilityTestComponentEvent"
  ]
  un-planned-event-names: [
    "ActivityUnPlannedInAbilityTestComponentEvent",
    "TestUnPlannedInAbilityTestComponentEvent"
  ]
  entity-prefix: "cata"
  colsMap: {
    "cata_course_id" : "cata_course_id",
    "cata_ability_test_activity_uuid" : "cata_ability_test_activity_uuid",
    "cata_ability_test_activity_id" : "cata_ability_test_activity_id",
    "cata_ability_test_id" : "cata_ability_test_id",
    "cata_ability_test_type" : "cata_ability_test_type",
    "cata_max_attempts" : "cata_max_attempts",
    "cata_ability_test_pacing" : "cata_ability_test_pacing",
    "cata_ability_test_index" : "cata_ability_test_index",
    "cata_course_version" : "cata_course_version",
    "occurredOn" : "occurredOn",
    "cata_ability_test_type" : "cata_ability_test_type",
    "cata_status" : "cata_status",
    "cata_attach_status" : "cata_attach_status",
    "cata_ability_test_activity_type": "cata_ability_test_activity_type",
    "cata_metadata": "cata_metadata",
    "cata_is_placement_test": "cata_is_placement_test"
  }
  plannedColsMap: {
    eventType : "eventType",
    courseId : "cata_course_id",
    activityId.uuid : "cata_ability_test_activity_uuid",
    activityId.id : "cata_ability_test_activity_id",
    parentItemId : "cata_ability_test_id",
    index : "cata_ability_test_index",
    courseVersion : "cata_course_version",
    maxAttempts : "cata_max_attempts",
    settings.pacing : "cata_ability_test_pacing",
    isPlacementTest: "cata_is_placement_test",
    occurredOn : "occurredOn"
  }
  unPlannedColsMap: {
    eventType : "eventType",
    courseId : "cata_course_id",
    activityId.uuid : "cata_ability_test_activity_uuid",
    activityId.id : "cata_ability_test_activity_id",
    parentItemId : "cata_ability_test_id",
    index : "cata_ability_test_index",
    courseVersion : "cata_course_version",
    maxAttempts : "cata_max_attempts",
    modulePacing : "cata_ability_test_pacing",
    isPlacementTest: "cata_is_placement_test",
    occurredOn : "occurredOn"
  }
  testColsMap: {
    eventType : "eventType",
    courseId : "cata_course_id",
    id : "cata_ability_test_activity_uuid",
    legacyId : "cata_ability_test_activity_id",
    parentComponentId : "cata_ability_test_id",
    parentComponentType: "parentComponentType",
    index : "cata_ability_test_index",
    courseVersion : "cata_course_version",
    maxAttempts : "cata_max_attempts",
    settings.pacing : "cata_ability_test_pacing",
    type: "cata_ability_test_activity_type",
    metadata: "cata_metadata",
    isPlacementTest: "cata_is_placement_test",
    occurredOn : "occurredOn"
  }
  groupKeys: ["cata_course_id", "cata_ability_test_id", "cata_ability_test_activity_uuid"]
}

redshift-course-ability-test {
  source: "parquet-course-ability-test-transformed-sink"
  sink: ["redshift-course-ability-test-sink"]
  unique-ids: ["cata_course_id", "cata_ability_test_activity_uuid"]
  inactive_status_value: 4
  is_staging_sink: false
  excluded-columns: ["cata_metadata"]
}

delta-course-ability-test {
  source: "parquet-course-ability-test-transformed-sink"
  sink: ["delta-course-ability-test-sink"]
  inactive_status_value: 4
  unique-ids: ["cata_course_id", "cata_ability_test_activity_uuid"]
  match-conditions: "delta.cata_course_id = events.cata_course_id AND delta.cata_ability_test_activity_uuid = events.cata_ability_test_activity_uuid"
}