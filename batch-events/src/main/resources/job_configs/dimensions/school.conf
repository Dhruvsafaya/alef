#-------Dim School-------
parquet-school-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-school-schoolMutated"}
parquet-school-status-toggle-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-school-status"}

parquet-school-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-school-schoolMutated"}
parquet-school-status-toggle-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-school-status"}

transformed-school-organization-sink = ${parquet-source-overwrite} {"path": ${s3.path}"/"${env}"/transformed/alef-school-organization"}
transformed-school-created-sink = ${parquet-source-overwrite} {"path": ${s3.path}"/"${env}"/transformed/alef-school-created"}
transformed-school-updated-sink = ${parquet-source-overwrite} {"path": ${s3.path}"/"${env}"/transformed/alef-school-updated"}
transformed-school-status-updated-sink = ${parquet-source-overwrite} {"path": ${s3.path}"/"${env}"/transformed/alef-school-status-updated"}
transformed-school-deleted-sink = ${parquet-source-overwrite} {"path": ${s3.path}"/"${env}"/transformed/alef-school-deleted"}
transformed-school-content-repository-association = ${parquet-source-overwrite} {"path": ${s3.path}"/"${env}"/transformed/alef-school-content-repository-association"}

redshift-school-dim = ${fabric} {"dbtable": ${fabric-schema}".dim_school"}
delta-school-sink = ${delta-sink} {"path": ${s3.delta.path}"/"${env}"/alef-school"}

redshift-school-content-repository-association-rel = ${redshift} {"dbtable": ${redshift-staging-schema}".rel_school_content_repository_association"}
delta-school-content-repository-association-sink = ${delta-sink} {"path": ${s3.delta.path}"/"${env}"/alef-school-content-repository-association"}

parquet-school {
  source: [
    "parquet-school-source"
  ]
  sink: [
    "parquet-school-sink"
  ]
}

parquet-school-status-toggle {
  source: [
    "parquet-school-status-toggle-source"
  ]
  sink: [
    "parquet-school-status-toggle-sink"
  ]
}

transform-school-organization {
  source: [
    "parquet-school-source"
  ]
  sink: [
    "transformed-school-organization-sink"
  ]
}

transform-school-created {
  source: [
    "transformed-school-organization-sink"
  ]
  sink: [
    "transformed-school-created-sink"
  ]
}

transform-school-update-combined {
  source: [
    "transformed-school-organization-sink",
    "parquet-school-status-toggle-source"
  ]
  sink: [
    "transformed-school-updated-sink",
    "transformed-school-status-updated-sink",
    "transformed-school-deleted-sink"
  ]
}

transform-school-content-repository-association {
    source: [
        "parquet-school-source"
    ]
    sink: [
        "transformed-school-content-repository-association"
    ]
}

redshift-school-created {
  source: [
    "transformed-school-created-sink"
  ]
  sink: [
    "redshift-school-dim"
  ]
}

redshift-school-update-combined {
  source: [
    "transformed-school-updated-sink",
    "transformed-school-status-updated-sink",
    "transformed-school-deleted-sink"
  ]
  sink: [
    "redshift-school-dim"
  ]
}

delta-school-created {
  source: [
    "transformed-school-created-sink"
  ]
  sink: [
    "delta-school-sink"
  ]
}

delta-school-update-combined {
  source: [
    "transformed-school-updated-sink",
    "transformed-school-status-updated-sink",
    "transformed-school-deleted-sink"
  ]
  sink: [
    "delta-school-sink"
  ]
}

redshift-school-content-repository-association-service {
    source: "transformed-school-content-repository-association"
    sink: [
        "redshift-school-content-repository-association-rel"
    ]
    unique-ids: ["scra_school_id"]
    entity-prefix: "scra"
    dim-table: "dim_school_content_repository_association"
    rel-table: "rel_school_content_repository_association"
}

delta-school-content-repository-association-service {
    source: "transformed-school-content-repository-association"
    sink: [
        "delta-school-content-repository-association-sink"
    ]
    unique-ids: ["scra_school_id"]
    entity-prefix: "scra"
}

#-------Dim School AY Association-------
parquet-school-academic-year-switched-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/admin-school-academic-year-switched"}
parquet-school-academic-year-roll-over-completed-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/admin-school-academic-year-roll-over-completed"}

parquet-school-academic-year-switched-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/admin-school-academic-year-switched"}
parquet-school-academic-year-roll-over-completed-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/admin-school-academic-year-roll-over-completed"}

transformed-school-academic-year-sink = ${parquet-source-overwrite} {"path": ${s3.path}"/"${env}"/transformed/alef-school-academic-year"}

school-academic-year-redshift-sink = ${redshift} {"dbtable": ${redshift-schema}".dim_school_academic_year_association"}

school-academic-year-delta-sink = ${delta-sink} {"path": ${s3.delta.path}"/"${env}"/alef-school-academic-year-association"}

parquet-school-academic-year-switched {
  source: [
    "parquet-school-academic-year-switched-source"
  ]
  sink: [
    "parquet-school-academic-year-switched-sink"
  ]
}

parquet-school-academic-year-roll-over-completed {
  source: [
    "parquet-school-academic-year-roll-over-completed-source"
  ]
  sink: [
    "parquet-school-academic-year-roll-over-completed-sink"
  ]
}

transform-school-academic-year {
  source: [
    "parquet-school-source",
    "parquet-school-academic-year-switched-source",
    "parquet-school-academic-year-roll-over-completed-source"
  ]
  sink: [
    "transformed-school-academic-year-sink"
  ]
  entity-prefix: "saya"
  key: "dim_school_academic_year_association"
}

redshift-school-academic-year-service {
  source: "transformed-school-academic-year-sink"
  sink: ["school-academic-year-redshift-sink"]
  unique-ids: ["saya_school_id"]
  inactive_status_value: 2
  is_staging_sink: false
}

delta-school-academic-year-service {
  source: "transformed-school-academic-year-sink"
  sink: ["school-academic-year-delta-sink"]
  unique-ids: ["saya_school_id"]
  match-conditions: "delta.saya_school_id = events.saya_school_id"
  inactive_status_value: 2
}

#-------Dim CX School-------
parquet-cx-school-source = ${parquet-source} {"path": ${s3.path}"/"${env}"/processing/alef-cx-schools"}
parquet-cx-school-sink = ${parquet-source} {"path": ${s3.path}"/"${env}"/data/alef-cx-school"}
parquet-stage-cx-school = ${parquet-source} {"outputMode":"overwrite" , "mode":"overwrite", "path": ${s3.path}"/"${env}"/staging/alef-cx-schools"}

redshift-cx-school-sink = ${redshift-school-dim}
delta-cx-school-sink = ${delta-school-sink}

cx-school-dimension {
  source: [
    "parquet-cx-school-source",
    "parquet-stage-cx-school"
  ]
  sink: [
    "parquet-cx-school-sink",
    "parquet-stage-cx-school",
    "redshift-cx-school-sink",
    "delta-cx-school-sink"
  ]
}