package com.alefeducation.util

import com.alefeducation.bigdata.commons.testutils.SparkSuite
import org.apache.spark.sql.functions.{col, to_timestamp}
import com.alefeducation.util.BatchSessionUtility._
import org.apache.spark.sql.{Column, DataFrame}


class BatchSessionUtilityTest extends SparkSuite {

  val jsonEventIncGame: String =
    """
      |[
      |{"inc_game_session_id":"6f358fe2-b303-442b-aa13-d22a0532fba0","inc_game_session_created_time":"2020-07-21T06:34:25.081Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"test","inc_game_session_num_players":9,"inc_game_session_num_joined_players":-1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":4,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"04430a9c-4ba8-4d52-a4b5-3f78d74fd018"},
      |{"inc_game_session_id":"6f358fe2-b303-442b-aa13-d22a0532fba0","inc_game_session_created_time":"2020-07-21T06:34:29.453Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"test","inc_game_session_num_players":9,"inc_game_session_num_joined_players":0,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":3,"inc_game_session_is_start":false,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"04430a9c-4ba8-4d52-a4b5-3f78d74fd018"},
      |{"inc_game_session_id":"d8b84f27-25e6-467f-977f-42a118b78b86","inc_game_session_created_time":"2020-07-21T06:45:06.925Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"test","inc_game_session_num_players":9,"inc_game_session_num_joined_players":-1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":4,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"04430a9c-4ba8-4d52-a4b5-3f78d74fd018"},
      |{"inc_game_session_id":"d8b84f27-25e6-467f-977f-42a118b78b86","inc_game_session_created_time":"2020-07-21T06:45:24.032Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"test","inc_game_session_num_players":9,"inc_game_session_num_joined_players":1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":1,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"04430a9c-4ba8-4d52-a4b5-3f78d74fd018"},
      |{"inc_game_session_id":"d8b84f27-25e6-467f-977f-42a118b78b86","inc_game_session_created_time":"2020-07-21T06:46:43.591Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"test","inc_game_session_num_players":9,"inc_game_session_num_joined_players":1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":2,"inc_game_session_is_start":false,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"04430a9c-4ba8-4d52-a4b5-3f78d74fd018"},
      |{"inc_game_session_id":"c454bd53-fc9c-481c-b404-8144044a0461","inc_game_session_created_time":"2020-07-21T06:52:16.593Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"testingdfg","inc_game_session_num_players":3,"inc_game_session_num_joined_players":-1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":4,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"cd3d8c66-2f27-472d-8235-bd7a5d19a02a"},
      |{"inc_game_session_id":"c454bd53-fc9c-481c-b404-8144044a0461","inc_game_session_created_time":"2020-07-21T06:52:30.187Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"testingdfg","inc_game_session_num_players":3,"inc_game_session_num_joined_players":1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":1,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"cd3d8c66-2f27-472d-8235-bd7a5d19a02a"},
      |{"inc_game_session_id":"c454bd53-fc9c-481c-b404-8144044a0461","inc_game_session_created_time":"2020-07-21T06:53:22.079Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"testingdfg","inc_game_session_num_players":3,"inc_game_session_num_joined_players":1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":2,"inc_game_session_is_start":false,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"cd3d8c66-2f27-472d-8235-bd7a5d19a02a"},
      |{"inc_game_session_id":"4847d666-97be-454c-ad9d-1dcadf4e5e1d","inc_game_session_created_time":"2020-07-21T06:56:30.966Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"testxcg","inc_game_session_num_players":3,"inc_game_session_num_joined_players":-1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":4,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42"},
      |{"inc_game_session_id":"4847d666-97be-454c-ad9d-1dcadf4e5e1d","inc_game_session_created_time":"2020-07-21T06:56:41.119Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"testxcg","inc_game_session_num_players":3,"inc_game_session_num_joined_players":1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":1,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42"},
      |{"inc_game_session_id":"4847d666-97be-454c-ad9d-1dcadf4e5e1d","inc_game_session_created_time":"2020-07-21T06:57:19.724Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200721","inc_game_session_title":"testxcg","inc_game_session_num_players":3,"inc_game_session_num_joined_players":1,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_status":3,"inc_game_session_is_start":false,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42"},
      |{"inc_game_session_id":"a257d0d6-f81d-4963-8ebe-64ab596e66fa","inc_game_session_created_time":"2020-07-23T03:06:08.648Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200723","inc_game_session_title":"testxcg","inc_game_session_num_players":9,"inc_game_session_num_joined_players":-1,"inc_game_session_started_by":"ca85e5e5-9734-417d-b19e-84ce258e4869","inc_game_session_status":4,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42"},
      |{"inc_game_session_id":"a257d0d6-f81d-4963-8ebe-64ab596e66fa","inc_game_session_created_time":"2020-07-23T03:06:20.138Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200723","inc_game_session_title":"testxcg","inc_game_session_num_players":9,"inc_game_session_num_joined_players":0,"inc_game_session_started_by":"ca85e5e5-9734-417d-b19e-84ce258e4869","inc_game_session_status":3,"inc_game_session_is_start":false,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42"},
      |{"inc_game_session_id":"a257d0d6-f81d-4963-8ebe-64ab596eSSSS","inc_game_session_created_time":"2020-07-23T03:06:08.648Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200723","inc_game_session_title":"testxcg","inc_game_session_num_players":9,"inc_game_session_num_joined_players":-1,"inc_game_session_started_by":"ca85e5e5-9734-417d-b19e-84ce258e4869","inc_game_session_status":4,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42"},
      |{"inc_game_session_id":"a257d0d6-f81d-4963-8ebe-64ab596eSSSS","inc_game_session_created_time":"2020-07-23T03:06:08.648Z","inc_game_session_dw_created_time":"2020-08-27T04:42:35.553Z","inc_game_session_date_dw_id":"20200723","inc_game_session_title":"testxcg","inc_game_session_num_players":9,"inc_game_session_num_joined_players":-1,"inc_game_session_started_by":"ca85e5e5-9734-417d-b19e-84ce258e4869","inc_game_session_status":1,"inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42"}
      |]
      |""".stripMargin

  val jsonEventPractice: String =
    """
      |[
      |{"practice_session_created_time":"2020-07-22T02:13:37.710Z","practice_session_dw_created_time":"2020-08-26T16:37:41.894Z","practice_session_date_dw_id":20200722,"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_sa_score":33.0,"practice_session_item_content_title":"Check My Understanding 2","practice_session_item_content_lesson_type":"TEQ_2","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ2;ANY;2","practice_session_score":1.0,"practice_session_event_type":3,"practice_session_is_start":false,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"f99918a9-0e6a-4a5a-980c-b15ad62e02ee","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e"},
      |{"practice_session_created_time":"2020-07-22T02:24:58.602Z","practice_session_dw_created_time":"2020-08-26T16:37:41.894Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_item_content_title":"Check My Understanding 3","practice_session_item_content_lesson_type":"TEQ_3","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ3;ANY;1","practice_session_score":0.0,"practice_session_event_type":3,"practice_session_is_start":false,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"d9d457e8-f67b-407e-b6d9-ed2a0a67df63","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:24:12.025Z","practice_session_dw_created_time":"2020-08-26T16:37:41.740Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_item_content_title":"Check My Understanding 1","practice_session_item_content_lesson_type":"TEQ_1","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ1;ANY;2","practice_session_score":-1.0,"practice_session_event_type":3,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"fc36d1f3-43a8-47bc-b080-0d45d0794ff6","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:24:58.603Z","practice_session_dw_created_time":"2020-08-26T16:37:41.357Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_score":20.0,"practice_session_event_type":1,"practice_session_is_start":false,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":0,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:13:32.159Z","practice_session_dw_created_time":"2020-08-26T16:37:41.740Z","practice_session_date_dw_id":20200722,"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_sa_score":33.0,"practice_session_item_content_title":"Check My Understanding 2","practice_session_item_content_lesson_type":"TEQ_2","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ2;ANY;2","practice_session_score":-1.0,"practice_session_event_type":3,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"f99918a9-0e6a-4a5a-980c-b15ad62e02ee","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e"},
      |{"practice_session_created_time":"2020-07-22T02:13:27.526Z","practice_session_dw_created_time":"2020-08-26T16:37:41.474Z","practice_session_date_dw_id":20200722,"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_sa_score":33.0,"practice_session_score":-1.0,"practice_session_event_type":2,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e"},
      |{"practice_session_created_time":"2020-07-22T02:24:41.902Z","practice_session_dw_created_time":"2020-08-26T16:37:41.740Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_item_content_title":"Check My Understanding 3","practice_session_item_content_lesson_type":"TEQ_3","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ3;ANY;1","practice_session_score":-1.0,"practice_session_event_type":3,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"d9d457e8-f67b-407e-b6d9-ed2a0a67df63","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:24:26.156Z","practice_session_dw_created_time":"2020-08-26T16:37:41.894Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_item_content_title":"Check My Understanding 1","practice_session_item_content_lesson_type":"TEQ_1","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ1;ANY;2","practice_session_score":0.0,"practice_session_event_type":3,"practice_session_is_start":false,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"fc36d1f3-43a8-47bc-b080-0d45d0794ff6","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:24:12.025Z","practice_session_dw_created_time":"2020-08-26T16:37:41.234Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_score":-1.0,"practice_session_event_type":1,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:13:27.527Z","practice_session_dw_created_time":"2020-08-26T16:37:41.740Z","practice_session_date_dw_id":20200722,"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_sa_score":33.0,"practice_session_item_content_title":"Check My Understanding 1","practice_session_item_content_lesson_type":"TEQ_1","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ1;ANY;2","practice_session_score":-1.0,"practice_session_event_type":3,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"fc36d1f3-43a8-47bc-b080-0d45d0794ff6","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e"},
      |{"practice_session_created_time":"2020-07-22T02:24:41.216Z","practice_session_dw_created_time":"2020-08-26T16:37:41.894Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_item_content_title":"Check My Understanding 2","practice_session_item_content_lesson_type":"TEQ_2","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ2;ANY;2","practice_session_score":0.5,"practice_session_event_type":3,"practice_session_is_start":false,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"f99918a9-0e6a-4a5a-980c-b15ad62e02ee","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:24:58.603Z","practice_session_dw_created_time":"2020-08-26T16:37:41.617Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_score":20.0,"practice_session_event_type":2,"practice_session_is_start":false,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:13:37.861Z","practice_session_dw_created_time":"2020-08-26T16:37:41.740Z","practice_session_date_dw_id":20200722,"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_sa_score":33.0,"practice_session_item_content_title":"Check My Understanding 3","practice_session_item_content_lesson_type":"TEQ_3","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ3;ANY;1","practice_session_score":-1.0,"practice_session_event_type":3,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"d9d457e8-f67b-407e-b6d9-ed2a0a67df63","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e"},
      |{"practice_session_created_time":"2020-07-22T02:13:32.030Z","practice_session_dw_created_time":"2020-08-26T16:37:41.894Z","practice_session_date_dw_id":20200722,"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_sa_score":33.0,"practice_session_item_content_title":"Check My Understanding 1","practice_session_item_content_lesson_type":"TEQ_1","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ1;ANY;2","practice_session_score":1.0,"practice_session_event_type":3,"practice_session_is_start":false,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"fc36d1f3-43a8-47bc-b080-0d45d0794ff6","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e"},
      |{"practice_session_created_time":"2020-07-22T02:13:27.526Z","practice_session_dw_created_time":"2020-08-26T16:37:41.234Z","practice_session_date_dw_id":20200722,"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_sa_score":33.0,"practice_session_score":-1.0,"practice_session_event_type":1,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e"},
      |{"practice_session_created_time":"2020-07-22T02:24:26.867Z","practice_session_dw_created_time":"2020-08-26T16:37:41.740Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_item_content_title":"Check My Understanding 2","practice_session_item_content_lesson_type":"TEQ_2","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ2;ANY;2","practice_session_score":-1.0,"practice_session_event_type":3,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"f99918a9-0e6a-4a5a-980c-b15ad62e02ee","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"},
      |{"practice_session_created_time":"2020-07-22T02:24:12.025Z","practice_session_dw_created_time":"2020-08-26T16:37:41.474Z","practice_session_date_dw_id":20200722,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_sa_score":0.0,"practice_session_score":-1.0,"practice_session_event_type":2,"practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_outside_of_school":true,"practice_session_stars":-1,"practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92"}
      |]
    """.stripMargin

  val endEventColsPractice = List(
    "practice_session_date_dw_id",
    "practice_session_is_start",
    "practice_session_score",
    "practice_session_sa_score")

  val isEndEventGroupConditionPractice: Column = col("practice_session_is_start") === false
  val isSessionStartedConditionPractice: Column = col("practice_session_is_start") === true

  val entityPractice = "practice_session"

  test("calculate time spent for practice session events") {

    val expectedPracticeSessionStartEndEventsJson =
      """
        |[
        |{"practice_session_item_content_lesson_type": null,"practice_session_item_content_location": null, "practice_session_item_content_title": null, "practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_item_lo_id": null,"practice_session_item_content_id": null,"practice_session_start_time":"2020-07-22T02:24:12.025Z","practice_session_end_time":"2020-07-22T02:24:58.603Z","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_dw_created_time":"2020-09-06T08:52:43.821Z","practice_session_event_type":1,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start_event_processed":false,"practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_date_dw_id":20200722,"practice_session_is_start":false,"practice_session_score":20.0,"practice_session_sa_score":0.0,"practice_session_time_spent":46}
        |]
      """.stripMargin

    val expectedPracticeSessionStartEventsJson =
      """
        |[
        |{"practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2022-07-21T12:24:39.909Z","practice_session_event_type":1,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_sa_score":0.0,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_score":-1.0,"practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:24:12.025Z","practice_session_end_time":null, "practice_session_time_spent":null},
        |{"practice_session_item_content_lesson_type": null,"practice_session_item_content_location": null, "practice_session_item_content_title": null, "practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_item_lo_id": null,"practice_session_item_content_id": null,"practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2020-09-06T08:52:46.117Z","practice_session_event_type":1,"practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_outside_of_school":true,"practice_session_sa_score":33.0,"practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_score":-1.0,"practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_stars":-1,"practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:13:27.526Z", "practice_session_end_time":null, "practice_session_time_spent":null}
        |]
      """.stripMargin

    val df = createPracticeDf(1)

    val ids = List("practice_session_id")

    val (startEndEventsDf, startEventsDf) = transformForDelta(
      entityPractice,
      ids,
      endEventColsPractice,
      isEndEventGroupConditionPractice,
      isSessionStartedConditionPractice,
      consumeAllStartEvents = true)(df)

    assertSmallDatasetEquality(entityPractice, startEndEventsDf, createExpectedDf(entityPractice, expectedPracticeSessionStartEndEventsJson))
    assertSmallDatasetEquality(entityPractice, startEventsDf, createExpectedDf(entityPractice, expectedPracticeSessionStartEventsJson))
  }

  test("calculate time spent for practice item session events") {
    val expectedPracticeItemSessionStartEndEventsJson =
      """
        |[
        |{"practice_session_item_content_lesson_type": null,"practice_session_item_content_location": null, "practice_session_item_content_title": null,"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_item_content_id":null,"practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_start_time":"2020-07-22T02:24:12.025Z","practice_session_end_time":"2020-07-22T02:24:58.603Z","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_dw_created_time":"2020-09-06T18:12:28.564Z","practice_session_event_type":2,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start_event_processed":false,"practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_date_dw_id":20200722,"practice_session_is_start":false,"practice_session_score":20.0,"practice_session_sa_score":0.0,"practice_session_time_spent":46}
        |]
      """.stripMargin

    val expectedPracticeItemSessionStartEventsJson =
      """
        |[
        |{"practice_session_item_content_lesson_type": null,"practice_session_item_content_location": null, "practice_session_item_content_title": null,"practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_item_content_id":null,"practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2020-09-06T18:12:29.362Z","practice_session_event_type":2,"practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_outside_of_school":true,"practice_session_sa_score":33.0,"practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_score":-1.0,"practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_stars":-1,"practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:13:27.526Z","practice_session_end_time":null, "practice_session_time_spent":null},
        |{"practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2022-07-22T09:58:20.042Z","practice_session_event_type":2,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_sa_score":0.0,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_score":-1.0,"practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:24:12.025Z","practice_session_end_time":null, "practice_session_time_spent":null}
        |]
      """.stripMargin

    val df = createPracticeDf(2)

    val ids = List("practice_session_id", "practice_session_item_lo_id")

    val (startEndEventsDf, startEventsDf) = transformForDelta(
      entityPractice,
      ids,
      endEventColsPractice,
      isEndEventGroupConditionPractice,
      isSessionStartedConditionPractice,
      consumeAllStartEvents = true)(df)

    assertSmallDatasetEquality(entityPractice, startEndEventsDf, createExpectedDf(entityPractice, expectedPracticeItemSessionStartEndEventsJson))
    assertSmallDatasetEquality(entityPractice, startEventsDf, createExpectedDf(entityPractice, expectedPracticeItemSessionStartEventsJson))
  }

  test("calculate time spent for practice item content sessions events" ) {

    val expectedPracticeItemContentSessionStartEndEventsJson =
      """
        |[
        |{"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"f99918a9-0e6a-4a5a-980c-b15ad62e02ee","practice_session_start_time":"2020-07-22T02:13:32.159Z","practice_session_end_time":"2020-07-22T02:13:37.710Z","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e","practice_session_dw_created_time":"2020-09-06T08:28:36.574Z","practice_session_event_type":3,"practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start_event_processed":false,"practice_session_item_content_lesson_type":"TEQ_2","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ2;ANY;2","practice_session_item_content_title":"Check My Understanding 2","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_outside_of_school":true,"practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_stars":-1,"practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_date_dw_id":20200722,"practice_session_is_start":false,"practice_session_score":1.0,"practice_session_sa_score":33.0,"practice_session_time_spent":5},
        |{"practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"fc36d1f3-43a8-47bc-b080-0d45d0794ff6","practice_session_start_time":"2020-07-22T02:13:27.527Z","practice_session_end_time":"2020-07-22T02:13:32.030Z","practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e","practice_session_dw_created_time":"2020-09-06T08:28:36.574Z","practice_session_event_type":3,"practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start_event_processed":false,"practice_session_item_content_lesson_type":"TEQ_1","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ1;ANY;2","practice_session_item_content_title":"Check My Understanding 1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_outside_of_school":true,"practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_stars":-1,"practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_date_dw_id":20200722,"practice_session_is_start":false,"practice_session_score":1.0,"practice_session_sa_score":33.0,"practice_session_time_spent":5},
        |{"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"d9d457e8-f67b-407e-b6d9-ed2a0a67df63","practice_session_start_time":"2020-07-22T02:24:41.902Z","practice_session_end_time":"2020-07-22T02:24:58.602Z","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_dw_created_time":"2020-09-06T08:28:36.574Z","practice_session_event_type":3,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start_event_processed":false,"practice_session_item_content_lesson_type":"TEQ_3","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ3;ANY;1","practice_session_item_content_title":"Check My Understanding 3","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_date_dw_id":20200722,"practice_session_is_start":false,"practice_session_score":0.0,"practice_session_sa_score":0.0,"practice_session_time_spent":17},
        |{"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"f99918a9-0e6a-4a5a-980c-b15ad62e02ee","practice_session_start_time":"2020-07-22T02:24:26.867Z","practice_session_end_time":"2020-07-22T02:24:41.216Z","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_dw_created_time":"2020-09-06T08:28:36.574Z","practice_session_event_type":3,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start_event_processed":false,"practice_session_item_content_lesson_type":"TEQ_2","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ2;ANY;2","practice_session_item_content_title":"Check My Understanding 2","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_date_dw_id":20200722,"practice_session_is_start":false,"practice_session_score":0.5,"practice_session_sa_score":0.0,"practice_session_time_spent":15},
        |{"practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_item_content_id":"fc36d1f3-43a8-47bc-b080-0d45d0794ff6","practice_session_start_time":"2020-07-22T02:24:12.025Z","practice_session_end_time":"2020-07-22T02:24:26.156Z","practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_dw_created_time":"2020-09-06T08:28:36.574Z","practice_session_event_type":3,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start_event_processed":false,"practice_session_item_content_lesson_type":"TEQ_1","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ1;ANY;2","practice_session_item_content_title":"Check My Understanding 1","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_date_dw_id":20200722,"practice_session_is_start":false,"practice_session_score":0.0,"practice_session_sa_score":0.0,"practice_session_time_spent":14}
        |]
      """.stripMargin

    val expectedPracticeItemContentSessionStartEventsJson =
      """
        |[
        |{"practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2022-07-22T10:01:35.136Z","practice_session_event_type":3,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_item_content_id":"fc36d1f3-43a8-47bc-b080-0d45d0794ff6","practice_session_item_content_lesson_type":"TEQ_1","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ1;ANY;2","practice_session_item_content_title":"Check My Understanding 1","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_sa_score":0.0,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_score":-1.0,"practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:24:12.025Z","practice_session_end_time":null, "practice_session_time_spent":null},
        |{"practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2022-07-22T10:01:35.136Z","practice_session_event_type":3,"practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_item_content_id":"f99918a9-0e6a-4a5a-980c-b15ad62e02ee","practice_session_item_content_lesson_type":"TEQ_2","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ2;ANY;2","practice_session_item_content_title":"Check My Understanding 2","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_outside_of_school":true,"practice_session_sa_score":33.0,"practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_score":-1.0,"practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_stars":-1,"practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:13:32.159Z"},
        |{"practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2022-07-22T10:01:35.136Z","practice_session_event_type":3,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_item_content_id":"d9d457e8-f67b-407e-b6d9-ed2a0a67df63","practice_session_item_content_lesson_type":"TEQ_3","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ3;ANY;1","practice_session_item_content_title":"Check My Understanding 3","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_sa_score":0.0,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_score":-1.0,"practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:24:41.902Z"} ,
        |{"practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2022-07-22T10:01:35.136Z","practice_session_event_type":3,"practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_item_content_id":"fc36d1f3-43a8-47bc-b080-0d45d0794ff6","practice_session_item_content_lesson_type":"TEQ_1","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ1;ANY;2","practice_session_item_content_title":"Check My Understanding 1","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_outside_of_school":true,"practice_session_sa_score":33.0,"practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_score":-1.0,"practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_stars":-1,"practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:13:27.527Z"},
        |{"practice_session_academic_year_id":"5c0af89d-f659-4e87-a349-63a7f85cfbe2","practice_session_class_id":"986968c9-6d01-4826-8299-42c693626e8e","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2022-07-22T10:01:35.136Z","practice_session_event_type":3,"practice_session_grade_id":"20ee061e-6420-4440-a533-3f4d66a8ff91","practice_session_id":"9ec17535-d463-4c1c-8abb-ac1795dc0d31","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_item_content_id":"d9d457e8-f67b-407e-b6d9-ed2a0a67df63","practice_session_item_content_lesson_type":"TEQ_3","practice_session_item_content_location":"/content/alef-assessment?rules=5ee6bc92665a2b0001afe19e;TEQ3;ANY;1","practice_session_item_content_title":"Check My Understanding 3","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"e92e1474-525f-44af-9920-000000009460","practice_session_outside_of_school":true,"practice_session_sa_score":33.0,"practice_session_school_id":"ebd357c0-892f-4320-bac4-baf18571faa0","practice_session_score":-1.0,"practice_session_section_id":"d692ef67-4f81-4a94-aefc-3e460685ed90","practice_session_stars":-1,"practice_session_student_id":"892f63b1-a6f2-4992-ab41-f60a954b77ff","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:13:37.861Z"},
        |{"practice_session_academic_year_id":"e00c6f6d-25f3-4e4e-8443-a68f8a1b58fd","practice_session_class_id":"e2923a71-5d21-40ae-b822-c79e8db75a92","practice_session_date_dw_id":20200722,"practice_session_dw_created_time":"2022-07-22T10:01:35.136Z","practice_session_event_type":3,"practice_session_grade_id":"79b10752-357d-4586-aaf4-a3459ba102be","practice_session_id":"fddcbb9e-a942-4300-8248-7ec5f75859fc","practice_session_instructional_plan_id":"2db48da3-7f1f-4804-8371-ca3c3e1aa6a1","practice_session_is_start":true,"practice_session_is_start_event_processed":false,"practice_session_item_content_id":"f99918a9-0e6a-4a5a-980c-b15ad62e02ee","practice_session_item_content_lesson_type":"TEQ_2","practice_session_item_content_location":"/content/alef-assessment?rules=5c90aa7bc242820001f9118d;TEQ2;ANY;2","practice_session_item_content_title":"Check My Understanding 2","practice_session_item_lo_id":"11321b75-69c1-4847-898f-b5ed794e285a","practice_session_learning_path_id":"4d7359e4-6234-4340-b444-a0b4623484f8","practice_session_lo_id":"890d3948-3b90-4592-b23f-b623833313ec","practice_session_outside_of_school":true,"practice_session_sa_score":0.0,"practice_session_school_id":"142fd17d-393f-486c-8b77-468aeef7426d","practice_session_score":-1.0,"practice_session_section_id":"2ea75ad6-de79-48a0-b967-4aa60e022d83","practice_session_stars":-1,"practice_session_student_id":"57e7e283-8edf-46e0-b50c-ae949826af30","practice_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","practice_session_start_time":"2020-07-22T02:24:26.867Z"}
        |]
      """.stripMargin


    val df = createPracticeDf(3)

    val ids = List("practice_session_id", "practice_session_item_lo_id", "practice_session_item_content_id")


    val (startEndEventsDf, startEventsDf) = transformForDelta(
      entityPractice,
      ids,
      endEventColsPractice,
      isEndEventGroupConditionPractice,
      isSessionStartedConditionPractice,
      consumeAllStartEvents = true)(df)

    assertSmallDatasetEquality(entityPractice, startEndEventsDf, createExpectedDf(entityPractice, expectedPracticeItemContentSessionStartEndEventsJson))
    assertSmallDatasetEquality(entityPractice, startEventsDf, createExpectedDf(entityPractice, expectedPracticeItemContentSessionStartEventsJson))
  }

  test("calculate time spent for inc game sessions events") {
    val expectedIncGameSessionStartEndEventsJson =
      """
        |[
        |{"inc_game_session_id":"4847d666-97be-454c-ad9d-1dcadf4e5e1d","inc_game_session_start_time":"2020-07-21T06:56:41.119Z","inc_game_session_end_time":"2020-07-21T06:57:19.724Z","inc_game_session_dw_created_time":"2020-09-06T19:05:35.619Z","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42","inc_game_session_is_start_event_processed":false,"inc_game_session_num_joined_players":1,"inc_game_session_num_players":3,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_title":"testxcg","inc_game_session_date_dw_id":"20200721","inc_game_session_is_start":false,"inc_game_session_status":3,"inc_game_session_time_spent":38},
        |{"inc_game_session_id":"6f358fe2-b303-442b-aa13-d22a0532fba0","inc_game_session_start_time":"2020-07-21T06:34:25.081Z","inc_game_session_end_time":"2020-07-21T06:34:29.453Z","inc_game_session_dw_created_time":"2020-09-06T19:05:35.619Z","inc_game_session_game_id":"04430a9c-4ba8-4d52-a4b5-3f78d74fd018","inc_game_session_is_start_event_processed":false,"inc_game_session_num_joined_players":-1,"inc_game_session_num_players":9,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_title":"test","inc_game_session_date_dw_id":"20200721","inc_game_session_is_start":false,"inc_game_session_status":3},
        |{"inc_game_session_id":"a257d0d6-f81d-4963-8ebe-64ab596e66fa","inc_game_session_start_time":"2020-07-23T03:06:08.648Z","inc_game_session_end_time":"2020-07-23T03:06:20.138Z","inc_game_session_dw_created_time":"2020-09-06T19:05:35.619Z","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42","inc_game_session_is_start_event_processed":false,"inc_game_session_num_joined_players":-1,"inc_game_session_num_players":9,"inc_game_session_started_by":"ca85e5e5-9734-417d-b19e-84ce258e4869","inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_title":"testxcg","inc_game_session_date_dw_id":"20200723","inc_game_session_is_start":false,"inc_game_session_status":3},
        |{"inc_game_session_id":"c454bd53-fc9c-481c-b404-8144044a0461","inc_game_session_start_time":"2020-07-21T06:52:30.187Z","inc_game_session_end_time":"2020-07-21T06:53:22.079Z","inc_game_session_dw_created_time":"2020-09-06T19:05:35.619Z","inc_game_session_game_id":"cd3d8c66-2f27-472d-8235-bd7a5d19a02a","inc_game_session_is_start_event_processed":false,"inc_game_session_num_joined_players":1,"inc_game_session_num_players":3,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_title":"testingdfg","inc_game_session_date_dw_id":"20200721","inc_game_session_is_start":false,"inc_game_session_status":2,"inc_game_session_time_spent":52},
        |{"inc_game_session_id":"d8b84f27-25e6-467f-977f-42a118b78b86","inc_game_session_start_time":"2020-07-21T06:45:24.032Z","inc_game_session_end_time":"2020-07-21T06:46:43.591Z","inc_game_session_dw_created_time":"2020-09-06T19:05:35.619Z","inc_game_session_game_id":"04430a9c-4ba8-4d52-a4b5-3f78d74fd018","inc_game_session_is_start_event_processed":false,"inc_game_session_num_joined_players":1,"inc_game_session_num_players":9,"inc_game_session_started_by":"71da94a8-b951-4311-9262-e87220ab649f","inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_title":"test","inc_game_session_date_dw_id":"20200721","inc_game_session_is_start":false,"inc_game_session_status":2,"inc_game_session_time_spent":79}
        |]
      """.stripMargin

    val expectedIncGameSessionStartEventsJson =
      """
        |[
        |{"inc_game_session_date_dw_id":"20200723","inc_game_session_dw_created_time":"2020-09-06T19:05:36.133Z","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42","inc_game_session_id":"a257d0d6-f81d-4963-8ebe-64ab596eSSSS","inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_num_joined_players":-1,"inc_game_session_num_players":9,"inc_game_session_started_by":"ca85e5e5-9734-417d-b19e-84ce258e4869","inc_game_session_status":4,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_title":"testxcg","inc_game_session_start_time":"2020-07-23T03:06:08.648Z","inc_game_session_end_time":null, "inc_game_session_time_spent":null},
        |{"inc_game_session_date_dw_id":"20200723","inc_game_session_dw_created_time":"2020-09-06T19:05:36.133Z","inc_game_session_game_id":"6a6dbe43-316e-46b9-b0f6-d83f46177a42","inc_game_session_id":"a257d0d6-f81d-4963-8ebe-64ab596eSSSS","inc_game_session_is_start":true,"inc_game_session_is_start_event_processed":false,"inc_game_session_num_joined_players":-1,"inc_game_session_num_players":9,"inc_game_session_started_by":"ca85e5e5-9734-417d-b19e-84ce258e4869","inc_game_session_status":1,"inc_game_session_tenant_id":"93e4949d-7eff-4707-9201-dac917a5e013","inc_game_session_title":"testxcg","inc_game_session_start_time":"2020-07-23T03:06:08.648Z","inc_game_session_end_time":null, "inc_game_session_time_spent":null}
        |]
      """.stripMargin


    val endEventCols = List(
      "inc_game_session_date_dw_id",
      "inc_game_session_is_start",
      "inc_game_session_status")

    val ids = List("inc_game_session_id")

    val isEndEventGroupCondition = col("inc_game_session_status").isin(2, 3)
    val isSessionStartedCondition = col("inc_game_session_status") === 1

    val entity = "inc_game_session"

    val df = createIncGameDf()

    val (startEndEventsDf, startEventsDf) = transformForDelta(
      entity,
      ids,
      endEventCols,
      isEndEventGroupCondition,
      isSessionStartedCondition)(df)

    assertSmallDatasetEquality(entity, startEndEventsDf, createExpectedDf(entity, expectedIncGameSessionStartEndEventsJson))
    assertSmallDatasetEquality(entity, startEventsDf, createExpectedDf(entity, expectedIncGameSessionStartEventsJson))
  }

  def assertSmallDatasetEquality(entity: String, actualDf: DataFrame, expectedDf: DataFrame): Unit = {
    assert(actualDf.columns.toSet == expectedDf.columns.toSet)
    val a = defaultSortDataset(actualDf).drop(s"${entity}_dw_created_time")
    val e = defaultSortDataset(expectedDf).drop(s"${entity}_dw_created_time")
    assert(a.collect().sameElements(e.collect()))
  }

  def defaultSortDataset(df: DataFrame): DataFrame = {
    val colNames = df.columns.sorted
    val cols     = colNames.map(col)
    df.select(cols: _*).sort(cols: _*)
  }

  def createIncGameDf(): DataFrame = {
    createDfFromJson(jsonEventIncGame)
      .withColumn("inc_game_session_created_time", to_timestamp(col("inc_game_session_created_time")))
  }

  def createPracticeDf(eventType: Int): DataFrame = {
    createDfFromJson(jsonEventPractice)
      .withColumn("practice_session_created_time", to_timestamp(col("practice_session_created_time")))
      .filter(col("practice_session_event_type") === eventType)
  }

  def createExpectedDf(entity: String, json: String): DataFrame = {
    createDfFromJson(json)
      .withColumn(s"${entity}_dw_created_time", to_timestamp(col(s"${entity}_dw_created_time")))
      .withColumn(s"${entity}_start_time", to_timestamp(col(s"${entity}_start_time")))
      .withColumn(s"${entity}_end_time", to_timestamp(col(s"${entity}_end_time")))

  }

  def createDfFromJson(json: String): DataFrame = {
    val sparkSession = spark
    import sparkSession.implicits._

    spark.read
      .option("multiline", "true")
      .option("inferTimestamp", "false")
      .json(Seq(json).toDS)
  }
}
