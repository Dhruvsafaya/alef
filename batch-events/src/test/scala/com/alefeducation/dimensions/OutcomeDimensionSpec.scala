package com.alefeducation.dimensions

import com.alefeducation.bigdata.commons.testutils.SparkSuite
import com.alefeducation.util.Constants.{OutcomeCreatedEvent, OutcomeDeletedEvent, OutcomeUpdatedEvent}
import com.alefeducation.util.DataFrameEqualityUtils.{assertSmallDatasetEquality, createDfFromJson}
import com.alefeducation.util.Helpers._
import org.apache.spark.sql.functions.col
import org.apache.spark.sql.types.TimestampType
import org.apache.spark.sql.{DataFrame, SparkSession}

import java.util.TimeZone

class OutcomeDimensionSpec extends SparkSuite with BaseDimensionSpec {

  test("Test empty DataFrame case") {
    implicit val transformer = new OutcomeDimension(OutcomeDimensionName, spark)

    val fixtures = List(
      SparkFixture(key = ParquetOutcomeCreatedSource, value = ""),
      SparkFixture(key = ParquetOutcomeUpdatedSource, value = ""),
      SparkFixture(key = ParquetOutcomeDeletedSource, value = "")
    )

    withSparkFixtures(fixtures, sinks => assert(sinks.isEmpty))
  }

  test("Test outcome Created/Updated/Deleted Events ") {
    val expParquetJson =
      """
        |[
        |{"boardId":392027,"description":"Test_verssion_strand desc","eventDateDw":"20200708","eventType":"OutcomeCreatedEvent","gradeId":596550,"loadtime":"2020-07-08T05:18:02.053Z","name":"Test_verssion_strand","occurredOn":"2020-07-08 05:18:02.030","outcomeId":"strand-58","outcomeType":"STRAND","parentId":"","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-08"},
        |{"boardId":392027,"description":"Test_verssion_std","eventDateDw":"20200708","eventType":"OutcomeCreatedEvent","gradeId":596550,"loadtime":"2020-07-08T05:18:15.311Z","name":"Test_verssion_std","occurredOn":"2020-07-08 05:18:15.302","outcomeId":"standard-106","outcomeType":"STANDARD","parentId":"strand-58","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-08"},
        |{"boardId":392027,"description":"Test_verssion_sub_std desc","eventDateDw":"20200708","eventType":"OutcomeCreatedEvent","gradeId":596550,"loadtime":"2020-07-08T05:18:49.529Z","name":"Test_verssion_sub_std","occurredOn":"2020-07-08 05:18:49.516","outcomeId":"substandard-5","outcomeType":"SUBSTANDARD","parentId":"standard-106","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-08"},
        |{"boardId":392027,"description":"CO_strand desc","eventDateDw":"20200708","eventType":"OutcomeCreatedEvent","gradeId":596550,"loadtime":"2020-07-08T05:27:42.448Z","name":"CO_strand","occurredOn":"2020-07-08 05:27:42.442","outcomeId":"strand-59","outcomeType":"STRAND","parentId":"","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-08"},
        |{"boardId":392027,"description":"new v2 s","eventDateDw":"20200708","eventType":"OutcomeCreatedEvent","gradeId":333938,"loadtime":"2020-07-08T07:43:49.736Z","name":"new v2 s","occurredOn":"2020-07-08 07:43:49.731","outcomeId":"strand-60","outcomeType":"STRAND","parentId":"","subjectId":1,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-08"},
        |{"boardId":999999,"description":"ALEF","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":322135,"loadtime":"2020-07-09T11:02:04.716Z","name":"STRAND111","occurredOn":"2020-07-09 11:02:04.695","outcomeId":"strand-61","outcomeType":"STRAND","parentId":"","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":392027,"description":"Tets Samvel","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":322135,"loadtime":"2020-07-09T11:02:57.934Z","name":"Tets Samvel","occurredOn":"2020-07-09 11:02:57.928","outcomeId":"strand-62","outcomeType":"STRAND","parentId":"","subjectId":876678,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":999999,"description":"ALEF","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":322135,"loadtime":"2020-07-09T11:03:07.453Z","name":"STANDARD111","occurredOn":"2020-07-09 11:03:07.449","outcomeId":"standard-107","outcomeType":"STANDARD","parentId":"strand-61","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":999999,"description":"121212","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":322135,"loadtime":"2020-07-09T11:03:29.455Z","name":"SUBSTANDARD111","occurredOn":"2020-07-09 11:03:29.452","outcomeId":"substandard-6","outcomeType":"SUBSTANDARD","parentId":"standard-107","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":392027,"description":"Tets standart Samvel","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":322135,"loadtime":"2020-07-09T11:03:37.232Z","name":"Tets standart Samvel","occurredOn":"2020-07-09 11:03:37.228","outcomeId":"standard-108","outcomeType":"STANDARD","parentId":"strand-62","subjectId":876678,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":999999,"description":"safdsfdf","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":322135,"loadtime":"2020-07-09T11:03:49.910Z","name":"SUBLEVEL111","occurredOn":"2020-07-09 11:03:49.905","outcomeId":"sublevel-2","outcomeType":"SUBLEVEL","parentId":"substandard-6","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":392027,"description":"Tets substandart Samvel","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":322135,"loadtime":"2020-07-09T11:03:54.487Z","name":"Tets substandart Samvel","occurredOn":"2020-07-09 11:03:54.484","outcomeId":"substandard-7","outcomeType":"SUBSTANDARD","parentId":"standard-108","subjectId":876678,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":392027,"description":"Tets sublevel Samvel","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":322135,"loadtime":"2020-07-09T11:04:13.239Z","name":"Tets sublevel Samvel","occurredOn":"2020-07-09 11:04:13.236","outcomeId":"sublevel-3","outcomeType":"SUBLEVEL","parentId":"substandard-7","subjectId":876678,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":1000000,"description":"Test Outcome","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":231997,"loadtime":"2020-07-09T11:42:06.888Z","name":"Test Outcome","occurredOn":"2020-07-09 11:42:06.884","outcomeId":"strand-63","outcomeType":"STRAND","parentId":"","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":1000000,"description":"Test Outcome Standard","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":231997,"loadtime":"2020-07-09T11:42:20.279Z","name":"Test Outcome Standard","occurredOn":"2020-07-09 11:42:20.277","outcomeId":"standard-109","outcomeType":"STANDARD","parentId":"strand-63","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":1000000,"description":"Test Outcome Standard 2","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":231997,"loadtime":"2020-07-09T11:42:35.756Z","name":"Test Outcome Standard 2","occurredOn":"2020-07-09 11:42:35.754","outcomeId":"standard-110","outcomeType":"STANDARD","parentId":"strand-63","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"},
        |{"boardId":1000000,"description":"Test Outcome Skill 111","eventDateDw":"20200709","eventType":"OutcomeCreatedEvent","gradeId":231997,"loadtime":"2020-07-09T11:42:36.756Z","name":"Test Outcome Skill 111","occurredOn":"2020-07-09 11:42:36.754","outcomeId":"skill-111","outcomeType":"SKILL","parentId":"skill-63","subjectId":571671,"translations":[{"languageCode":"AR","value":"new dfrs"}],"eventdate":"2020-07-09"}
        |]
        |""".stripMargin
    val expRedshiftJson =
      """
        |[
        |{"outcome_name":"Test Outcome Skill 111","outcome_description":"Test Outcome Skill 111","outcome_type":5,"outcome_curriculum_subject_id":571671,"outcome_id":"skill-111","outcome_curriculum_id":1000000,"outcome_parent_id":"skill-63","outcome_curriculum_grade_id":231997,"outcome_created_time":"2020-07-09T11:42:36.754Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test_verssion_std","outcome_description":"Test_verssion_std","outcome_type":2,"outcome_curriculum_subject_id":571671,"outcome_id":"standard-106","outcome_curriculum_id":392027,"outcome_parent_id":"strand-58","outcome_curriculum_grade_id":596550,"outcome_created_time":"2020-07-08T05:18:15.302Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"STANDARD111","outcome_description":"ALEF","outcome_type":2,"outcome_curriculum_subject_id":571671,"outcome_id":"standard-107","outcome_curriculum_id":999999,"outcome_parent_id":"strand-61","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:07.449Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Tets standart Samvel","outcome_description":"Tets standart Samvel","outcome_type":2,"outcome_curriculum_subject_id":876678,"outcome_id":"standard-108","outcome_curriculum_id":392027,"outcome_parent_id":"strand-62","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:37.228Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test Outcome Standard","outcome_description":"Test Outcome Standard","outcome_type":2,"outcome_curriculum_subject_id":571671,"outcome_id":"standard-109","outcome_curriculum_id":1000000,"outcome_parent_id":"strand-63","outcome_curriculum_grade_id":231997,"outcome_created_time":"2020-07-09T11:42:20.277Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test Outcome Standard 2","outcome_description":"Test Outcome Standard 2","outcome_type":2,"outcome_curriculum_subject_id":571671,"outcome_id":"standard-110","outcome_curriculum_id":1000000,"outcome_parent_id":"strand-63","outcome_curriculum_grade_id":231997,"outcome_created_time":"2020-07-09T11:42:35.754Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test_verssion_strand","outcome_description":"Test_verssion_strand desc","outcome_type":1,"outcome_curriculum_subject_id":571671,"outcome_id":"strand-58","outcome_curriculum_id":392027,"outcome_parent_id":"","outcome_curriculum_grade_id":596550,"outcome_created_time":"2020-07-08T05:18:02.030Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"CO_strand","outcome_description":"CO_strand desc","outcome_type":1,"outcome_curriculum_subject_id":571671,"outcome_id":"strand-59","outcome_curriculum_id":392027,"outcome_parent_id":"","outcome_curriculum_grade_id":596550,"outcome_created_time":"2020-07-08T05:27:42.442Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"new v2 s","outcome_description":"new v2 s","outcome_type":1,"outcome_curriculum_subject_id":1,"outcome_id":"strand-60","outcome_curriculum_id":392027,"outcome_parent_id":"","outcome_curriculum_grade_id":333938,"outcome_created_time":"2020-07-08T07:43:49.731Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"STRAND111","outcome_description":"ALEF","outcome_type":1,"outcome_curriculum_subject_id":571671,"outcome_id":"strand-61","outcome_curriculum_id":999999,"outcome_parent_id":"","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:02:04.695Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Tets Samvel","outcome_description":"Tets Samvel","outcome_type":1,"outcome_curriculum_subject_id":876678,"outcome_id":"strand-62","outcome_curriculum_id":392027,"outcome_parent_id":"","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:02:57.928Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test Outcome","outcome_description":"Test Outcome","outcome_type":1,"outcome_curriculum_subject_id":571671,"outcome_id":"strand-63","outcome_curriculum_id":1000000,"outcome_parent_id":"","outcome_curriculum_grade_id":231997,"outcome_created_time":"2020-07-09T11:42:06.884Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"SUBLEVEL111","outcome_description":"safdsfdf","outcome_type":4,"outcome_curriculum_subject_id":571671,"outcome_id":"sublevel-2","outcome_curriculum_id":999999,"outcome_parent_id":"substandard-6","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:49.905Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Tets sublevel Samvel","outcome_description":"Tets sublevel Samvel","outcome_type":4,"outcome_curriculum_subject_id":876678,"outcome_id":"sublevel-3","outcome_curriculum_id":392027,"outcome_parent_id":"substandard-7","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:04:13.236Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test_verssion_sub_std","outcome_description":"Test_verssion_sub_std desc","outcome_type":3,"outcome_curriculum_subject_id":571671,"outcome_id":"substandard-5","outcome_curriculum_id":392027,"outcome_parent_id":"standard-106","outcome_curriculum_grade_id":596550,"outcome_created_time":"2020-07-08T05:18:49.516Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"SUBSTANDARD111","outcome_description":"121212","outcome_type":3,"outcome_curriculum_subject_id":571671,"outcome_id":"substandard-6","outcome_curriculum_id":999999,"outcome_parent_id":"standard-107","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:29.452Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Tets substandart Samvel","outcome_description":"Tets substandart Samvel","outcome_type":3,"outcome_curriculum_subject_id":876678,"outcome_id":"substandard-7","outcome_curriculum_id":392027,"outcome_parent_id":"standard-108","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:54.484Z","outcome_dw_created_time":"2023-06-19T13:03:01.431Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null}
        |]
      """.stripMargin
    val expRedshiftDf = createDfFromJsonWithTimeCols(spark, expRedshiftJson)
    val expDeltaJson =
      """
        |[
        |{"outcome_name":"Test Outcome Skill 111","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Test Outcome Skill 111","outcome_type":5,"outcome_curriculum_subject_id":571671,"outcome_id":"skill-111","outcome_curriculum_id":1000000,"outcome_parent_id":"skill-63","outcome_curriculum_grade_id":231997,"outcome_created_time":"2020-07-09T11:42:36.754Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test_verssion_std","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Test_verssion_std","outcome_type":2,"outcome_curriculum_subject_id":571671,"outcome_id":"standard-106","outcome_curriculum_id":392027,"outcome_parent_id":"strand-58","outcome_curriculum_grade_id":596550,"outcome_created_time":"2020-07-08T05:18:15.302Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"STANDARD111","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"ALEF","outcome_type":2,"outcome_curriculum_subject_id":571671,"outcome_id":"standard-107","outcome_curriculum_id":999999,"outcome_parent_id":"strand-61","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:07.449Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Tets standart Samvel","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Tets standart Samvel","outcome_type":2,"outcome_curriculum_subject_id":876678,"outcome_id":"standard-108","outcome_curriculum_id":392027,"outcome_parent_id":"strand-62","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:37.228Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test Outcome Standard","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Test Outcome Standard","outcome_type":2,"outcome_curriculum_subject_id":571671,"outcome_id":"standard-109","outcome_curriculum_id":1000000,"outcome_parent_id":"strand-63","outcome_curriculum_grade_id":231997,"outcome_created_time":"2020-07-09T11:42:20.277Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test Outcome Standard 2","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Test Outcome Standard 2","outcome_type":2,"outcome_curriculum_subject_id":571671,"outcome_id":"standard-110","outcome_curriculum_id":1000000,"outcome_parent_id":"strand-63","outcome_curriculum_grade_id":231997,"outcome_created_time":"2020-07-09T11:42:35.754Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test_verssion_strand","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Test_verssion_strand desc","outcome_type":1,"outcome_curriculum_subject_id":571671,"outcome_id":"strand-58","outcome_curriculum_id":392027,"outcome_parent_id":"","outcome_curriculum_grade_id":596550,"outcome_created_time":"2020-07-08T05:18:02.030Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"CO_strand","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"CO_strand desc","outcome_type":1,"outcome_curriculum_subject_id":571671,"outcome_id":"strand-59","outcome_curriculum_id":392027,"outcome_parent_id":"","outcome_curriculum_grade_id":596550,"outcome_created_time":"2020-07-08T05:27:42.442Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"new v2 s","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"new v2 s","outcome_type":1,"outcome_curriculum_subject_id":1,"outcome_id":"strand-60","outcome_curriculum_id":392027,"outcome_parent_id":"","outcome_curriculum_grade_id":333938,"outcome_created_time":"2020-07-08T07:43:49.731Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"STRAND111","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"ALEF","outcome_type":1,"outcome_curriculum_subject_id":571671,"outcome_id":"strand-61","outcome_curriculum_id":999999,"outcome_parent_id":"","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:02:04.695Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Tets Samvel","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Tets Samvel","outcome_type":1,"outcome_curriculum_subject_id":876678,"outcome_id":"strand-62","outcome_curriculum_id":392027,"outcome_parent_id":"","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:02:57.928Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test Outcome","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Test Outcome","outcome_type":1,"outcome_curriculum_subject_id":571671,"outcome_id":"strand-63","outcome_curriculum_id":1000000,"outcome_parent_id":"","outcome_curriculum_grade_id":231997,"outcome_created_time":"2020-07-09T11:42:06.884Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"SUBLEVEL111","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"safdsfdf","outcome_type":4,"outcome_curriculum_subject_id":571671,"outcome_id":"sublevel-2","outcome_curriculum_id":999999,"outcome_parent_id":"substandard-6","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:49.905Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Tets sublevel Samvel","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Tets sublevel Samvel","outcome_type":4,"outcome_curriculum_subject_id":876678,"outcome_id":"sublevel-3","outcome_curriculum_id":392027,"outcome_parent_id":"substandard-7","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:04:13.236Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Test_verssion_sub_std","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Test_verssion_sub_std desc","outcome_type":3,"outcome_curriculum_subject_id":571671,"outcome_id":"substandard-5","outcome_curriculum_id":392027,"outcome_parent_id":"standard-106","outcome_curriculum_grade_id":596550,"outcome_created_time":"2020-07-08T05:18:49.516Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"SUBSTANDARD111","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"121212","outcome_type":3,"outcome_curriculum_subject_id":571671,"outcome_id":"substandard-6","outcome_curriculum_id":999999,"outcome_parent_id":"standard-107","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:29.452Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null},
        |{"outcome_name":"Tets substandart Samvel","outcome_translations":[{"languageCode":"AR","value":"new dfrs"}],"outcome_description":"Tets substandart Samvel","outcome_type":3,"outcome_curriculum_subject_id":876678,"outcome_id":"substandard-7","outcome_curriculum_id":392027,"outcome_parent_id":"standard-108","outcome_curriculum_grade_id":322135,"outcome_created_time":"2020-07-09T11:03:54.484Z","outcome_dw_created_time":"2023-06-19T13:17:14.007Z","outcome_status":1,"outcome_updated_time":null,"outcome_dw_updated_time":null,"outcome_deleted_time":null}
        |]
      """.stripMargin
    val expDeltaDf = createDfFromJsonWithTimeCols(spark, expDeltaJson)

    implicit val transformer = new OutcomeDimension(ContentDimensionName, spark)
    val fixtures = List(
      SparkFixture(
        key = ParquetOutcomeCreatedSource,
        value =
          """
            |[
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-08T05:18:02.053Z","outcomeId":"strand-58","outcomeType":"STRAND","name":"Test_verssion_strand","description":"Test_verssion_strand desc","boardId":392027,"gradeId":596550,"subjectId":571671,"parentId":"","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-08 05:18:02.030","eventDateDw":"20200708"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-08T05:18:15.311Z","outcomeId":"standard-106","outcomeType":"STANDARD","name":"Test_verssion_std","description":"Test_verssion_std","boardId":392027,"gradeId":596550,"subjectId":571671,"parentId":"strand-58","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-08 05:18:15.302","eventDateDw":"20200708"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-08T05:18:49.529Z","outcomeId":"substandard-5","outcomeType":"SUBSTANDARD","name":"Test_verssion_sub_std","description":"Test_verssion_sub_std desc","boardId":392027,"gradeId":596550,"subjectId":571671,"parentId":"standard-106","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-08 05:18:49.516","eventDateDw":"20200708"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-08T05:27:42.448Z","outcomeId":"strand-59","outcomeType":"STRAND","name":"CO_strand","description":"CO_strand desc","boardId":392027,"gradeId":596550,"subjectId":571671,"parentId":"","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-08 05:27:42.442","eventDateDw":"20200708"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-08T07:43:49.736Z","outcomeId":"strand-60","outcomeType":"STRAND","name":"new v2 s","description":"new v2 s","boardId":392027,"gradeId":333938,"subjectId":1,"parentId":"","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-08 07:43:49.731","eventDateDw":"20200708"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:02:04.716Z","outcomeId":"strand-61","outcomeType":"STRAND","name":"STRAND111","description":"ALEF","boardId":999999,"gradeId":322135,"subjectId":571671,"parentId":"","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:02:04.695","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:02:57.934Z","outcomeId":"strand-62","outcomeType":"STRAND","name":"Tets Samvel","description":"Tets Samvel","boardId":392027,"gradeId":322135,"subjectId":876678,"parentId":"","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:02:57.928","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:03:07.453Z","outcomeId":"standard-107","outcomeType":"STANDARD","name":"STANDARD111","description":"ALEF","boardId":999999,"gradeId":322135,"subjectId":571671,"parentId":"strand-61","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:03:07.449","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:03:29.455Z","outcomeId":"substandard-6","outcomeType":"SUBSTANDARD","name":"SUBSTANDARD111","description":"121212","boardId":999999,"gradeId":322135,"subjectId":571671,"parentId":"standard-107","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:03:29.452","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:03:37.232Z","outcomeId":"standard-108","outcomeType":"STANDARD","name":"Tets standart Samvel","description":"Tets standart Samvel","boardId":392027,"gradeId":322135,"subjectId":876678,"parentId":"strand-62","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:03:37.228","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:03:49.910Z","outcomeId":"sublevel-2","outcomeType":"SUBLEVEL","name":"SUBLEVEL111","description":"safdsfdf","boardId":999999,"gradeId":322135,"subjectId":571671,"parentId":"substandard-6","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:03:49.905","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:03:54.487Z","outcomeId":"substandard-7","outcomeType":"SUBSTANDARD","name":"Tets substandart Samvel","description":"Tets substandart Samvel","boardId":392027,"gradeId":322135,"subjectId":876678,"parentId":"standard-108","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:03:54.484","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:04:13.239Z","outcomeId":"sublevel-3","outcomeType":"SUBLEVEL","name":"Tets sublevel Samvel","description":"Tets sublevel Samvel","boardId":392027,"gradeId":322135,"subjectId":876678,"parentId":"substandard-7","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:04:13.236","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:42:06.888Z","outcomeId":"strand-63","outcomeType":"STRAND","name":"Test Outcome","description":"Test Outcome","boardId":1000000,"gradeId":231997,"subjectId":571671,"parentId":"","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:42:06.884","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:42:20.279Z","outcomeId":"standard-109","outcomeType":"STANDARD","name":"Test Outcome Standard","description":"Test Outcome Standard","boardId":1000000,"gradeId":231997,"subjectId":571671,"parentId":"strand-63","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:42:20.277","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:42:35.756Z","outcomeId":"standard-110","outcomeType":"STANDARD","name":"Test Outcome Standard 2","description":"Test Outcome Standard 2","boardId":1000000,"gradeId":231997,"subjectId":571671,"parentId":"strand-63","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:42:35.754","eventDateDw":"20200709"},
            |{"eventType":"OutcomeCreatedEvent","loadtime":"2020-07-09T11:42:36.756Z","outcomeId":"skill-111","outcomeType":"SKILL","name":"Test Outcome Skill 111","description":"Test Outcome Skill 111","boardId":1000000,"gradeId":231997,"subjectId":571671,"parentId":"skill-63","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:42:36.754","eventDateDw":"20200709"}
            |]
            |""".stripMargin
      ),
      SparkFixture(
        key = ParquetOutcomeUpdatedSource,
        value =
          """
            |[
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:18:11.813Z","parentId":"", "outcomeId":"standard-108","name":"Tets standart Samvel","description":"Tets standart Samvel2 ","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:18:11.804","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:18:16.280Z","parentId":"", "outcomeId":"standard-108","name":"Tets standart Samvel","description":"Tets standart Samvel2 2 ","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:18:16.275","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:18:30.721Z","parentId":"", "outcomeId":"standard-108","name":"Tets standart Samvel","description":"Tets stans dart Samvel2 2 ","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:18:30.718","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:18:30.769Z","parentId":"", "outcomeId":"standard-108","name":"Tets standart Samvel","description":"Tets stans dart Samvel2 2 ","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:18:30.763","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:18:40.504Z","parentId":"", "outcomeId":"standard-108","name":"Tets standart Samvel","description":"Tets standart Samvel2 2 ","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:18:40.501","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:18:40.604Z","parentId":"", "outcomeId":"standard-108","name":"Tets standart Samvel","description":"Tets standart Samvel2 ","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:18:40.600","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:18:42.319Z","parentId":"", "outcomeId":"standard-108","name":"Tets standart Samvel","description":"Tets standart Samvel 2","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:18:42.315","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:18:59.905Z","parentId":"standard-108", "outcomeId":"substandard-7","name":"Tets substandart Samvel","description":"Tets substandart Samvel Edited","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:18:59.905","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:19:09.841Z","parentId":"standard-108", "outcomeId":"sublevel-3","name":"Tets sublevel Samvel","description":"Tets sublevel Samvel edited ","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:19:09.841","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:19:20.980Z","parentId":"sublevel-3", "outcomeId":"strand-62","name":"Tets Samvel","description":"Tets Samvel edited","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:19:20.977","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:19:35.828Z","parentId":"sublevel-3", "outcomeId":"strand-62","name":"Tets Samvel","description":"Tets Samvel edited again","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:19:35.825","eventDateDw":"20200709"},
            |{"eventType":"OutcomeUpdatedEvent","loadtime":"2020-07-09T11:19:36.807Z","parentId":"sublevel-3", "outcomeId":"strand-62","name":"Tets Samvel","description":"Tets Samvel edited again","translations": [{"languageCode": "AR","value": "new dfrs"}],"occurredOn":"2020-07-09 11:19:36.804","eventDateDw":"20200709"}
            |]
            |""".stripMargin
      ),
      SparkFixture(
        key = ParquetOutcomeDeletedSource,
        value =
          """
            |[
            |{"eventType":"OutcomeDeletedEvent","loadtime":"2020-07-09T11:19:45.401Z","outcomeId":"sublevel-3","occurredOn":"2020-07-09 11:19:45.397","eventDateDw":"20200709"},
            |{"eventType":"OutcomeDeletedEvent","loadtime":"2020-07-09T11:19:53.428Z","outcomeId":"substandard-7","occurredOn":"2020-07-09 11:19:53.427","eventDateDw":"20200709"},
            |{"eventType":"OutcomeDeletedEvent","loadtime":"2020-07-09T11:19:59.994Z","outcomeId":"standard-108","occurredOn":"2020-07-09 11:19:59.994","eventDateDw":"20200709"},
            |{"eventType":"OutcomeDeletedEvent","loadtime":"2020-07-09T11:20:06.462Z","outcomeId":"strand-62","occurredOn":"2020-07-09 11:20:06.462","eventDateDw":"20200709"}
            |]
            |""".stripMargin
      )
    )

    withSparkFixtures(
      fixtures, { sinks =>
        val expectedColsCreatedPqt: Seq[String] = OutcomeCreatedDimCols.keys.toSeq ++ commonParquetColumns
        val expectedColsUpdatedPqt: Seq[String] = OutcomeDimUpdatedCols.keys.toSeq ++ commonParquetColumns
        val expectedColsDeletedPqt: Seq[String] = OutcomeDimCols.keys.toSeq ++ commonParquetColumns

        val expectedColsCreatedRst: Seq[String] = OutcomeCreatedDimCols.values.toSeq.diff(Seq("occurredOn")) ++ commonRedshiftColumns(
          OutcomeEntity) :+ "outcome_status"
        val expectedColsUpdatedRst: Seq[String] = OutcomeDimUpdatedCols.values.toSeq.diff(Seq("occurredOn")) ++ commonRedshiftColumns(
          OutcomeEntity) :+ "outcome_status"
        val expectedColsDeletedRst: Seq[String] = OutcomeDimCols.values.toSeq.diff(Seq("occurredOn")) ++ commonRedshiftColumns(
          OutcomeEntity) :+ "outcome_status"

        testSinkBySinkName(sinks, ParquetOutcomeCreatedSource, expectedColsCreatedPqt, 17)
        testSinkBySinkName(sinks, ParquetOutcomeUpdatedSource, expectedColsUpdatedPqt, 12)
        testSinkBySinkName(sinks, ParquetOutcomeDeletedSource, expectedColsDeletedPqt, 4)

        testSinkByEventType(sinks, RedshiftOutcomeSink, OutcomeCreatedEvent, expectedColsCreatedRst.diff(Seq("outcome_translations")), 17)
        testSinkByEventType(sinks, RedshiftOutcomeSink, OutcomeUpdatedEvent, expectedColsUpdatedRst.diff(Seq("outcome_translations")), 4)
        testSinkByEventType(sinks, RedshiftOutcomeSink, OutcomeDeletedEvent, expectedColsDeletedRst, 4)

        testSinkByEventType(sinks, DeltaOutcomeSink, OutcomeCreatedEvent, expectedColsCreatedRst, 17)
        testSinkByEventType(sinks, DeltaOutcomeSink, OutcomeUpdatedEvent, expectedColsUpdatedRst, 4)
        testSinkByEventType(sinks, DeltaOutcomeSink, OutcomeDeletedEvent, expectedColsDeletedRst, 4)

        val parquetOutcomeDf = sinks.filter(_.name == ParquetOutcomeCreatedSource).head.output
        val redshiftOutcomeDf = sinks.filter(_.name == RedshiftOutcomeSink).head.output
        val deltaOutcomeDf = sinks.filter(_.name == DeltaOutcomeSink).head.output

        assertSmallDatasetEquality(spark, OutcomeEntity, parquetOutcomeDf, expParquetJson)
        assertSmallDatasetEquality(OutcomeEntity, redshiftOutcomeDf, expRedshiftDf)
        assertSmallDatasetEquality(OutcomeEntity, deltaOutcomeDf, expDeltaDf)
      }
    )
  }

  def createDfFromJsonWithTimeCols(spark: SparkSession, json: String): DataFrame = {
    createDfFromJson(spark, json)
      .withColumn(s"${OutcomeEntity}_created_time", col(s"${OutcomeEntity}_created_time").cast(TimestampType))
      .withColumn(s"${OutcomeEntity}_updated_time", col(s"${OutcomeEntity}_updated_time").cast(TimestampType))
  }

}
